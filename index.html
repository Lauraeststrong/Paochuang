<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>跑创 - 动态路径绘制</title>
    <!-- 引入高德地图 JS API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=5d85ca7ca6fdfbb78e9468a3c9d7ce09"></script>
    <style>
        #container { 
            width: 100%; 
            height: 100%; 
            position: absolute; 
            top: 0; 
            left: 0; 
        }
    </style>
</head>
<body>
    <div id="container"></div>

    <script>
        // 全局变量初始化
        var map, currentPosition = null, path = [], polyline, marker, geolocation, isDrawing = false, intervalID = null;

        // 初始化地图
        function initializeMap() {
            map = new AMap.Map('container', {
                zoom: 15 // 地图缩放级别
            });

            // 初始化路径绘制
            polyline = new AMap.Polyline({
                path: path, // 初始路径为空
                strokeColor: "#FF0000", // 路径颜色
                strokeWeight: 6, // 线条宽度
                strokeOpacity: 0.7, // 透明度
            });
            polyline.setMap(map);
        }

        // 初始化定位功能
        function initializeGeolocation() {
            AMap.plugin('AMap.Geolocation', function () {
                geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true, // 使用高精度定位
                    timeout: 10000, // 超时时间
                    position: 'RB', // 定位按钮位置
                    showCircle: false, // 隐藏定位精度圆
                    showMarker: false, // 不显示默认定位图标
                    isConverted: true, // 修正定位偏差
                });
                map.addControl(geolocation);

                // 获取初始位置
                geolocation.getCurrentPosition(function (status, result) {
                    if (status === 'complete') {
                        handleLocationUpdate(result.position);
                    } else {
                        console.error('初始定位失败', result);
                    }
                });

                // 监听位置变化
                geolocation.watchPosition(function (status, result) {
                    if (status === 'complete' && isDrawing) {
                        handleLocationUpdate(result.position);
                    }
                });
            });
        }

        // 处理位置更新
        function handleLocationUpdate(position) {
            currentPosition = position;

            // 更新地图中心点
            map.setCenter([currentPosition.lng, currentPosition.lat]);

            // 在地图上标记当前位置
            if (!marker) {
                marker = new AMap.Marker({
                    position: [currentPosition.lng, currentPosition.lat],
                });
                marker.setMap(map);
            } else {
                marker.setPosition([currentPosition.lng, currentPosition.lat]);
            }

            // 添加当前位置到路径并更新地图
            path.push([currentPosition.lng, currentPosition.lat]);
            polyline.setPath(path);
        }

        // 开始绘制路径
        function startDrawing() {
            if (isDrawing) return; // 防止重复启动
            isDrawing = true;

            // 每秒更新路径
            intervalID = setInterval(function () {
                if (currentPosition) {
                    path.push([currentPosition.lng, currentPosition.lat]);
                    polyline.setPath(path);
                }
            }, 1000);
        }

        // 暂停绘制路径
        function pauseDrawing() {
            isDrawing = false;
            if (intervalID) {
                clearInterval(intervalID); // 停止定时器
                intervalID = null;
            }
        }

        // 结束绘制路径
        function endDrawing() {
            pauseDrawing(); // 停止绘制
            path = []; // 清空路径
            polyline.setPath(path); // 更新地图
        }

        // 监听来自 Thunkable Web Viewer 的消息
        window.addEventListener("message", function (event) {
            var message = event.data;  // 获取消息内容
            if (message === "start") {
                startDrawing();  // 开始绘制路径
            } else if (message === "pause") {
                pauseDrawing();  // 暂停绘制路径
            } else if (message === "end") {
                endDrawing();  // 结束绘制路径
            }
        });

        // 初始化地图和定位
        initializeMap();
        initializeGeolocation();
    </script>
</body>
</html>
